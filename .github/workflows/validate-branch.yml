# Validate france.txt on feature change

name: feature/* Validate france.txt

# Controls when the workflow will run
on:
  push:
    branches: [ "feature/*",  "autogenerated/*"]
    paths:
      - 'france.txt'
      
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      manual_Run:
        description: 'Manually triggered'
        required: true
        default: 'warning'

  pull_request:
    branches:
      - main

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
# see: https://github.com/marketplace/actions/ftp-deployment
jobs:
  validate-airspace:
    if: github.ref != 'main'
    name: Validate OpenAir france.txt
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v3

    - name: ðŸ§± Setup Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - id: validation
      name:  Validate france.txt + generate .geojson
      run: |
        echo "## Install openaip-openair-parser"
        git clone https://github.com/openAIP/openaip-openair-parser.git
        cd openaip-openair-parser
        npm install
        npm run build
        echo "## Install openaip-openair-parser: Done !"

        echo "## Validating ..."
        rm ../france.geojson
        echo "Run validation script"
        node ./dist/cli.js --input-filepath ../france.txt --validate --output-filepath ../france.geojson --version 2.0
        SCRIPT_OUTPUT=$(node ./dist/cli.js --input-filepath ../france.txt --validate --output-filepath ../france.geojson --version 2.0)
          SCRIPT_RC=$?
          {
            echo "parser_output<<EOF"
            printf '%s\n' "$SCRIPT_OUTPUT"
            echo "EOF"
            echo "parser_rc=$SCRIPT_RC"
          } >> "$GITHUB_OUTPUT"

    outputs:
      validation-output: ${{ steps.validation.outputs.parser_output }}

  check-validation:
    name: Check Validation - Display and check output
    runs-on: ubuntu-latest
    needs: [validate-airspace]
    steps:
    - name: Display validation output
      run: |
        echo "Validation output="
        # Use printf with quoting so multiline output is treated as a single argument and not executed line-by-line
        printf '%s\n' "${{ needs.validate-airspace.outputs.validation-output }}"

    - name: Check validation
      if: |
        always() &&
        contains(needs.validate-airspace.outputs.validation-output, 'Error')
      uses: actions/github-script@v3
      with:
        script: |
          core.setFailed('Validation failed ! See Above step for details...')
        


